<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Quests</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="index.css">
    <link rel="icon" href="img/Logo.png">
    <style>
        /* small styles for the quest UI */
        #botToTopBtn {
            position: fixed;
            right: 20px;
            bottom: 20px;
            font-size: 28px;
            cursor: pointer;
            display: block;
        }

        .quest-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: .5rem 0;
        }

        .points-badge {
            min-width: 48px;
            text-align: center;
        }

        .explosion-canvas {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1050;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-sm bg-dark navbar-dark mr-auto ml-auto">
        <a class="navbar-brand" href="index.html">
            <img src="img/Logo.png" alt="Logo" style="width:60px;">
        </a>
        <ul class="navbar-nav">
            <li class="nav-item active">
                <a class="nav-link" href="index.html">Trang chủ</a>
            </li>
            <li class="nav-item active">
                <a class="nav-link" href="introduce.html">Nhiệm vụ hằng ngày</a>
            </li>

            <li class="nav-item">
                <a class="nav-link" href="contact1.html">Liên hệ</a>
            </li>
        </ul>
        <!-- <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <a class="nav-link" href="#" data-toggle="modal" data-target="#loginModal">Đăng nhập</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-toggle="modal" data-target="#registerModal">Đăng ký</a>
            </li>
        </ul> -->
    </nav>

    <!-- replaced main body: daily quests app -->
    <div class="container mt-4" id="dailyQuestsApp">
        <h3 class="text-center mb-3">Quests Hằng Ngày</h3>

        <div class="row">
            <div class="col-md-7">
                <div class="card">
                    <div class="card-body">
                        <p class="mb-1">Mỗi ngày tối đa nhận được <strong>10 điểm</strong>. Mỗi quest có giá trị riêng
                            (1-5 điểm).</p>
                        <form id="questsForm">
                            <div id="questsList" class="mb-2">
                                <!-- quests injected here -->
                            </div>
                        </form>

                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <div>
                                <button id="completeBtn" class="btn btn-success">Complete</button>
                                <button id="resetTodayBtn" class="btn btn-outline-secondary btn-sm">Reset Today</button>
                            </div>
                            <div>
                                <small>Đã nhận hôm nay: <span id="todayPoints">0</span>/10</small>
                            </div>
                        </div>

                        <div class="progress mt-3" style="height:18px;">
                            <div id="dailyProgress" class="progress-bar bg-info" role="progressbar" style="width: 0%">
                                0/10</div>
                        </div>
                    </div>
                </div>
                <small class="text-muted mt-2 d-block">Ghi chú: chỉ những quest chưa được đánh dấu completed hôm nay mới
                    cộng điểm khi bấm Complete. Điểm thặng dư vượt 10 trong ngày sẽ bị giới hạn.</small>
            </div>

            <div class="col-md-5">
                <div class="card">
                    <div class="card-body text-center">
                        <h5>Score Tổng</h5>
                        <h2 id="scoreTotal" style="letter-spacing:2px">0</h2>
                        <p id="scoreNote" class="text-muted mb-0">Đạt <strong>210</strong> điểm để kích hoạt hiệu ứng!
                        </p>
                        <div class="mt-3">
                            <button id="clearScoreBtn" class="btn btn-outline-danger btn-sm">Xóa Score</button>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-body">
                        <h6>Lịch sử / Trạng thái hôm nay</h6>
                        <ul id="todayStatus" class="list-unstyled mb-0"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- existing modals (login/register) remain unchanged -->
    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-dialog">
            <div class="modal-content">

                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title">Đăng Nhập</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>

                <!-- Modal body -->
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label>Email:</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fa-solid fa-envelope"></i></span>
                                </div>
                                <input class="form-control" type="email" id="email" placeholder="Nhập email">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Mật Khẩu:</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fa-solid fa-lock"></i></span>
                                </div>
                                <input class="form-control" type="password" id="password" placeholder="Nhập mật khẩu">
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Modal footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-dismiss="modal">Đăng nhập</button>
                </div>

            </div>
        </div>
    </div>



    <!-- Register Modal -->
    <div class="modal" id="registerModal">
        <div class="modal-dialog">
            <div class="modal-content">

                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title">Đăng Ký</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>

                <!-- Modal body -->
                <div class="modal-body">
                    <form>
                        <div class="form-group">
                            <label>Ảnh Đại Diện</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fa-solid fa-image"></i></span>
                                </div>
                                <div class="custom-file">
                                    <input type="file" class="custom-file-input" id="customFile">
                                    <label class="custom-file-label" for="customFile">Choose file</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Họ Tên:</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fa-solid fa-user"></i></span>
                                </div>
                                <input class="form-control" type="text" id="name" placeholder="Nhập tên">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Ngày Sinh:</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fa-solid fa-cake-candles"></i></span>
                                </div>
                                <input class="form-control" type="date" id="date">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Giới Tính:</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fa-solid fa-venus-mars"></i></span>
                                </div>
                                <select class="form-control">
                                    <option>Nam</option>
                                    <option>Nữ</option>
                                    <option>Khác</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Tình Trạng Hôn Nhân:</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fa-solid fa-spinner"></i></span>
                                </div>
                                <select class="form-control">
                                    <option>Độc Thân</option>
                                    <option>Đã kết hôn</option>
                                    <option>Khác</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Email:</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fa-solid fa-envelope"></i></span>
                                </div>
                                <input class="form-control" type="email" id="email" placeholder="Nhập email">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Mật Khẩu:</label>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="fa-solid fa-lock"></i></span>
                                </div>
                                <input class="form-control" type="password" id="password" placeholder="Nhập mật khẩu">
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Modal footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-dismiss="modal">Đăng ký</button>
                </div>

            </div>
        </div>
    </div>

    <!-- Claim / Prize Modal (show when score >= 210) -->
    <div class="modal" id="claimModal" tabindex="-1" role="dialog" aria-labelledby="claimModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="claimModalLabel">Bạn đã đạt 210 điểm!</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Đóng">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Xin chúc mừng! Bạn đã đạt <strong>210</strong> điểm. Vui lòng liên hệ Facebook chính thức của
                        admin để nhận quà:</p>
                    <p><a href="https://facebook.com/your-admin-page" id="adminFbLink" target="_blank"
                            rel="noopener">Facebook chính thức của admin</a></p>
                    <p class="text-muted small">Sau khi đã liên hệ, bấm "Đã liên hệ" để đánh dấu nhận quà.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="confirmContactBtn">Đã liên hệ</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- explosion canvas placeholder -->
    <canvas id="explosionCanvas" class="explosion-canvas" style="display:none;"></canvas>

    <!-- bot to top icon (existing) -->
    <i class="fa-solid fa-circle-arrow-up" onclick="botToTop()" id="botToTopBtn"></i>
    <footer class="mt-3 bg-body-tertiary text-center p-3 bg-dark" style="background-color: rgba(0, 0, 0, 0.05);">
        <!-- Grid container -->
        <div class="container p-4 pb-0">
            <!-- Section: Social media -->
                        <section class="mb-4">
                <!-- Facebook -->
                <a data-mdb-ripple-init class="btn text-white btn-floating m-1" style="background-color: #3b5998;"
                    href="https://www.facebook.com/people/Little-Ryan/61581956524218" role="button"><i
                        class="fab fa-facebook-f"></i></a>

                <!-- Instagram -->
                <a data-mdb-ripple-init class="btn text-white btn-floating m-1" style="background-color: #ac2bac;"
                    href="https://www.instagram.com/lil_ryan091701?igsh=c2E2ZHprZHBjZGl4" role="button"><i
                        class="fab fa-instagram"></i></a>

                <a data-mdb-ripple-init class="btn text-white btn-floating m-1" style="background-color: #ed302f;"
                    href="https://www.youtube.com/@lilryan4B" role="button"><i class="fab fa-youtube"></i></a>

                <!-- Chat GPT -->
                <a data-mdb-ripple-init class="btn text-white btn-floating m-1" style="background-color: #00acee;"
                    href="https://chatgpt.com/g/g-68de0cbfdde88191aef354c4a1e4a6e1-mental-coach-from-btx-hs-by-minh-phu" role="button"><i class="fa-solid fa-robot"></i></a>
            </section>
            <!-- Section: Social media -->
        </div>
        <!-- Grid container -->

        <!-- Copyright -->
        <div class="text-center p-3" style="background-color: rgba(0, 0, 0, 0.173); color:aliceblue">
            <a class="text-center" style="color:aqua" href="index.html">Ryan.com</a>
        </div>
        <!-- Copyright -->
    </footer>
    <script>
        (function () {
            // Quests setup: total per day must be <= 10
            const dailyCap = 10;
            const quests = [
                { id: 'q1', text: 'Night Mode 5’: rửa mặt, giãn cổ-vai, thở 4-7-8×2, viết 3 dòng “worry list”.', points: 2 },
                { id: 'q2', text: 'Zero-Blue 60’: tắt màn hình xanh 60’ trước ngủ; chỉ nghe audio; để máy xa ≥2m.', points: 4 },
                { id: 'q3', text: 'Sleep Window: vào giường & thức dậy đúng giờ mục tiêu (±15’); rời giường nếu >20’ chưa ngủ.', points: 1 },
                { id: 'q4', text: 'Morning Reset 5’: ánh sáng 2–5’, uống nước 300ml, vận động 2’, 3 nhịp thở chậm.', points: 3 }
                // tổng: 10
            ];

            const el = {
                list: document.getElementById('questsList'),
                todayPoints: document.getElementById('todayPoints'),
                dailyProgress: document.getElementById('dailyProgress'),
                completeBtn: document.getElementById('completeBtn'),
                scoreTotal: document.getElementById('scoreTotal'),
                todayStatus: document.getElementById('todayStatus'),
                resetTodayBtn: document.getElementById('resetTodayBtn'),
                clearScoreBtn: document.getElementById('clearScoreBtn'),
                explosionCanvas: document.getElementById('explosionCanvas')
            };

            // localStorage keys
            const KEY_SCORE = 'game_score_total';
            const KEY_DAY = 'game_day_date';
            const KEY_COMPLETED = 'game_day_completed'; // object map { date: [ids] }
            const KEY_PRIZE_CLAIMED = 'game_prize_claimed'; // mark if user confirmed contact for prize

            function todayKey() {
                return new Date().toISOString().slice(0, 10);
            }

            function showClaimModalIfNeeded() {
                // only show if not already confirmed by user
                if (localStorage.getItem(KEY_PRIZE_CLAIMED)) return;
                // use Bootstrap modal (jQuery available)
                if (window.$ && $('#claimModal').modal) {
                    $('#claimModal').modal('show');
                } else {
                    alert('Bạn đã đạt 210 điểm! Vui lòng liên hệ Facebook chính thức của admin: https://facebook.com/your-admin-page');
                }
            }

            function loadState() {
                const score = parseInt(localStorage.getItem(KEY_SCORE) || '0', 10);
                const date = localStorage.getItem(KEY_DAY) || '';
                let completedMap = JSON.parse(localStorage.getItem(KEY_COMPLETED) || '{}');
                // if stored date different, keep map but check entries by date keys
                return { score, date, completedMap };
            }

            function saveScore(score) {
                localStorage.setItem(KEY_SCORE, String(score));
            }

            function saveCompletedMap(map) {
                localStorage.setItem(KEY_COMPLETED, JSON.stringify(map));
            }

            function renderList() {
                const state = loadState();
                const today = todayKey();
                const completedMap = state.completedMap || {};
                const completedToday = new Set(completedMap[today] || []);
                el.list.innerHTML = '';
                quests.forEach(q => {
                    const checked = completedToday.has(q.id) ? 'checked disabled' : '';
                    const item = document.createElement('div');
                    item.className = 'quest-item';
                    item.innerHTML = `
                    <div class="form-check">
                        <input class="form-check-input quest-checkbox" type="checkbox" value="${q.id}" id="${q.id}" data-points="${q.points}" ${checked}>
                        <label class="form-check-label" for="${q.id}">
                            ${q.text}
                        </label>
                    </div>
                    <span class="badge badge-primary points-badge">${q.points} pt</span>
                `;
                    el.list.appendChild(item);
                });
                updateUI();
            }

            function sumCheckedPoints() {
                const inputs = Array.from(document.querySelectorAll('.quest-checkbox'));
                let sum = 0;
                inputs.forEach(i => {
                    if (i.checked && !i.disabled) sum += Number(i.dataset.points || 0);
                });
                return sum;
            }

            function sumCompletedToday() {
                const state = loadState();
                const today = todayKey();
                const completed = (state.completedMap && state.completedMap[today]) || [];
                return quests.filter(q => completed.includes(q.id)).reduce((s, q) => s + q.points, 0);
            }

            function updateUI() {
                const checkedSum = sumCheckedPoints();
                const completedSum = sumCompletedToday();
                const totalToday = Math.min(dailyCap, completedSum + checkedSum);
                el.todayPoints.textContent = totalToday;
                const pct = Math.round((totalToday / dailyCap) * 100);
                el.dailyProgress.style.width = pct + '%';
                el.dailyProgress.textContent = `${totalToday}/${dailyCap}`;
                const state = loadState();
                el.scoreTotal.textContent = state.score;
                // today status list
                el.todayStatus.innerHTML = '';
                const completed = (state.completedMap && state.completedMap[todayKey()]) || [];
                quests.forEach(q => {
                    const li = document.createElement('li');
                    li.innerHTML = `${q.text} — <strong>${q.points}pt</strong> ${completed.includes(q.id) ? '<span class="text-success"> (Done)</span>' : ''}`;
                    el.todayStatus.appendChild(li);
                });
            }

            el.completeBtn.addEventListener('click', function (e) {
                e.preventDefault();
                const state = loadState();
                const today = todayKey();
                const completedMap = state.completedMap || {};
                const completedToday = new Set(completedMap[today] || []);
                const newlyChecked = Array.from(document.querySelectorAll('.quest-checkbox'))
                    .filter(i => i.checked && !i.disabled)
                    .map(i => ({ id: i.value, points: Number(i.dataset.points || 0) }));

                let newPoints = newlyChecked.reduce((s, q) => s + q.points, 0);
                const alreadyPoints = sumCompletedToday();
                const remaining = Math.max(0, dailyCap - alreadyPoints);
                const pointsToAdd = Math.min(newPoints, remaining);

                if (pointsToAdd <= 0) {
                    alert('Không còn điểm có thể nhận hôm nay (đã đạt giới hạn 10 điểm).');
                    return;
                }

                // add to total score
                const newScore = state.score + pointsToAdd;
                saveScore(newScore);

                // mark those quest ids as completed for today (but only up to remaining)
                // we will greedily mark in order until remaining consumed
                let rem = remaining;
                completedMap[today] = completedMap[today] || [];
                for (const q of newlyChecked) {
                    if (rem <= 0) break;
                    if (!completedToday.has(q.id)) {
                        const take = Math.min(q.points, rem);
                        // If a quest is partially exceeding cap, we still mark it done but only award partial points
                        // For simplicity, we mark quest done once any points taken for it
                        completedMap[today].push(q.id);
                        rem -= take;
                    }
                }

                saveCompletedMap(completedMap);
                renderList();

                if (newScore >= 210) {
                    triggerExplosion();
                    // show contact popup/modal to claim prize
                    showClaimModalIfNeeded();
                }
            });

            // claim modal button: mark as claimed and close
            document.addEventListener('click', function (ev) {
                const t = ev.target;
                if (t && t.id === 'confirmContactBtn') {
                    localStorage.setItem(KEY_PRIZE_CLAIMED, '1');
                    if (window.$ && $('#claimModal').modal) $('#claimModal').modal('hide');
                    alert('Đã ghi nhận. Cảm ơn bạn đã liên hệ admin để nhận quà.');
                }
            });

            // reset today's completed quests (for testing)
            el.resetTodayBtn.addEventListener('click', function () {
                const confirmed = confirm('Reset trạng thái quests hôm nay?');
                if (!confirmed) return;
                const state = loadState();
                const map = state.completedMap || {};
                delete map[todayKey()];
                saveCompletedMap(map);
                renderList();
            });

            el.clearScoreBtn.addEventListener('click', function () {
                if (confirm('Xóa tổng Score?')) {
                    saveScore(0);
                    renderList();
                }
            });

            // explosion: simple particle burst on canvas
            function triggerExplosion() {
                const canvas = el.explosionCanvas;
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                canvas.style.display = 'block';
                const ctx = canvas.getContext('2d');
                const particles = [];
                const colors = ['#ff595e', '#ffca3a', '#8ac926', '#1982c4', '#6a4c93', '#ff6b6b', '#ffd166'];
                const cx = canvas.width / 2;
                const cy = canvas.height / 2;
                const count = 160;
                for (let i = 0; i < count; i++) {
                    const ang = Math.random() * Math.PI * 2;
                    const speed = 2 + Math.random() * 8;
                    particles.push({
                        x: cx,
                        y: cy,
                        vx: Math.cos(ang) * speed,
                        vy: Math.sin(ang) * speed,
                        life: 70 + Math.random() * 40,
                        r: 2 + Math.random() * 4,
                        c: colors[Math.floor(Math.random() * colors.length)]
                    });
                }
                let t = 0;
                function frame() {
                    t++;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    particles.forEach(p => {
                        p.x += p.vx;
                        p.y += p.vy;
                        p.vy += 0.08; // gravity
                        p.vx *= 0.99;
                        p.vy *= 0.99;
                        p.life--;
                        ctx.beginPath();
                        ctx.globalAlpha = Math.max(0, p.life / 100);
                        ctx.fillStyle = p.c;
                        ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                        ctx.fill();
                    });
                    ctx.globalAlpha = 1;
                    if (particles.some(p => p.life > 0)) {
                        requestAnimationFrame(frame);
                    } else {
                        canvas.style.display = 'none';
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                    }
                }
                frame();
                // small screen flash
                const flash = document.createElement('div');
                flash.style.position = 'fixed';
                flash.style.left = '0'; flash.style.top = '0';
                flash.style.width = '100%'; flash.style.height = '100%';
                flash.style.background = 'rgba(255,240,200,0.25)';
                flash.style.zIndex = 1049;
                document.body.appendChild(flash);
                setTimeout(() => document.body.removeChild(flash), 420);
            }

            // initial render
            renderList();
            // if user already has score >=210 on load, show modal (unless already confirmed)
            (function checkExistingScore() {
                const state = loadState();
                if (state.score >= 210) {
                    // trigger explosion visually once on load (optional) and show claim modal
                    // do not auto-trigger explosion repeatedly; just show claim modal
                    showClaimModalIfNeeded();
                }
            })();

            // ensure UI updates when checking/unchecking (update progress live)
            document.addEventListener('change', function (e) {
                if (e.target && e.target.classList && e.target.classList.contains('quest-checkbox')) {
                    // if a checkbox was disabled (already completed) ignore
                    updateUI();
                }
            });

            // keep responsive: re-create canvas size on resize
            window.addEventListener('resize', () => {
                if (el.explosionCanvas.style.display !== 'none') {
                    el.explosionCanvas.width = window.innerWidth;
                    el.explosionCanvas.height = window.innerHeight;
                }
            });

        })();
    </script>

    <script src="bot_to_top.js"></script>
</body>

</html>