<!doctype html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ryan</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="index.css">
  <link rel="icon" href="img/Logo.png">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="assets/icons/icon-192.png">
  <meta name="theme-color" content="#22d3ee">

</head>

<body>
  <nav class="navbar navbar-expand-sm bg-dark navbar-dark mr-auto ml-auto">
    <a class="navbar-brand" href="index.html">
      <img src="img/Logo.png" alt="Logo" style="width:60px;">
    </a>
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="index.html">Trang chủ</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="introduce.html">Nhiệm vụ hằng ngày</a>
      </li>

      <li class="nav-item">
        <a class="nav-link" href="PSQI.html">Tính PSQI</a>
      </li>

      <li class="nav-item active">
        <a class="nav-link" href="arcade.html">Harmony Arcade</a>
      </li>

      <li class="nav-item">
        <a class="nav-link" href="contact1.html">Liên hệ</a>
      </li>
    </ul>
    <!-- <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <a class="nav-link" href="#" data-toggle="modal" data-target="#loginModal">Đăng nhập</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-toggle="modal" data-target="#registerModal">Đăng ký</a>
            </li>
        </ul> -->
  </nav>

  <main class="container mt-3 mb-3">
    <section class="card p-3" aria-live="polite">
      <h1 class="card-title mb-2">Harmony Arcade — <span class="badge-primary">Dream Drift</span></h1>

      <div class="mt-2 d-flex flex-wrap align-items-center" style="gap:8px;">
        <span class="badge-primary">Streak: <span id="streak">0</span></span>
        <span class="badge-primary">Play Tokens: <span id="tokens">0</span>/<span id="tokenCap">3</span></span>
        <span class="badge-primary">Giới hạn: <span id="limit">10</span> phút/ngày</span>
        <span class="badge-primary">Giờ ngủ: <span id="curfew">21:30</span></span>
      </div>

      <p class="text-muted mt-2">Hoàn thành <b>Daily Ritual</b> để nhận token. Đủ <b>9 streak</b> sẽ mở <i>Harmony
          Arcade</i>. Chơi ≤ <b>90s/ván</b>, cooldown <b>3 phút</b>, tối đa <b>10 phút/ngày</b>.</p>

      <div class="d-flex flex-wrap align-items-center" style="gap:8px;">
        <button id="btnRitual" class="btn btn-outline-secondary">+1 Token (Hoàn thành Ritual)</button>
        <button id="btnPlay" class="btn btn-primary">Chơi</button>
        <button id="btnExport" class="btn btn-outline-secondary">Xuất log</button>

        <div class="form-check ml-2">
          <input type="checkbox" class="form-check-input" id="skipFx">
          <label class="form-check-label" for="skipFx">Bỏ qua hiệu ứng</label>
        </div>
      </div>

      <p class="text-muted text-center mb-2"><small>Điều khiển: giữ chuột/ngón tay hoặc giữ
          <kbd>Space</kbd>/<kbd>W</kbd>/<kbd>↑</kbd> để lượn lên; thả để hạ xuống.</small></p>

      <!-- Khung game có overlay + nút fullscreen -->
      <div id="gameWrap" class="game-wrap d-flex justify-content-center mx-auto p-3">
        <div class="game-stage">
          <canvas id="gg" aria-label="Khung trò chơi Dream Drift"></canvas>

          <!-- Vùng overlay: GIỮ để bay lên, NHẢ để hạ xuống -->
          <div id="zoneHold" class="zone-hold p-3" aria-label="Giữ để bay lên"></div>

          <!-- Nút fullscreen -->
          <button id="btnFS" type="button" class="btn btn-dark btn-sm fs-btn" title="Mở toàn màn hình">
            <i class="fa-solid fa-expand"></i>
          </button>
        </div>
      </div>

      <!-- (tuỳ chọn) Pad 2 nút truyền thống vẫn giữ được
      <div class="d-flex justify-content-center mt-2" id="pad">
        <div class="btn-group" role="group" aria-label="Điều khiển Dream Drift">
          <button id="btnHoldUp" class="btn btn-info btn-lg px-4" type="button">
            <i class="fa-solid fa-arrow-up"></i> Bay lên
          </button>
          <button id="btnHoldOff" class="btn btn-secondary btn-lg px-4" type="button">
            <i class="fa-solid fa-arrow-down"></i> Hạ xuống
          </button>
        </div>
      </div> -->



      <p id="gateMsg" class="text-accent text-center mt-2 mb-0"></p>
    </section>

    <section id="resultCard" class="card hl-modal-card mt-3" hidden>
      <div class="modal-header d-flex justify-content-between align-items-center">
        <h2 class="modal-title mb-0" id="resultTitle">Kết quả</h2>
      </div>
      <div id="resultBody" class="modal-content"
        style="border:none; box-shadow:none; background:transparent; padding:12px 16px;"></div>
      <div class="modal-footer d-flex" style="gap:8px;">
        <button id="btnReplay" class="btn btn-primary">Chơi lại</button>
        <button id="btnClose" class="btn btn-outline-secondary">Đóng</button>
      </div>
    </section>
  </main>

  <footer class="mt-3 bg-body-tertiary text-center p-3 bg-dark" style="background-color: rgba(0, 0, 0, 0.05);">
    <!-- Grid container -->
    <div class="container p-4 pb-0">
      <!-- Section: Social media -->
      <section class="mb-4">
        <!-- Facebook -->
        <a data-mdb-ripple-init class="btn text-white btn-floating m-1" style="background-color: #3b5998;"
          href="https://www.facebook.com/people/Little-Ryan/61581956524218" role="button" title="Facebook">
          <i class="fab fa-facebook-f"></i></a>

        <!-- Instagram -->
        <a data-mdb-ripple-init class="btn text-white btn-floating m-1" style="background-color: #ac2bac;"
          href="https://www.instagram.com/lil_ryan091701?igsh=c2E2ZHprZHBjZGl4" role="button" title="Instagram">
          <i class="fab fa-instagram"></i></a>

        <a data-mdb-ripple-init class="btn text-white btn-floating m-1" style="background-color: #ed302f;"
          href="https://www.youtube.com/@lilryan4B" role="button" title="YouTube">
          <i class="fab fa-youtube"></i></a>

        <!-- Chat GPT -->
        <a data-mdb-ripple-init class="btn text-white btn-floating m-1" style="background-color: #00acee;"
          href="https://chatgpt.com/g/g-68de0cbfdde88191aef354c4a1e4a6e1-mental-coach-from-btx-hs-by-minh-phu"
          role="button" title="Chatbot">
          <i class="fa-solid fa-robot"></i></a>

        <!-- Book 1: sách mở -->
        <a data-mdb-ripple-init class="btn text-white btn-floating m-1" style="background-color:#7952b3;"
          href="https://heyzine.com/flip-book/f040c395d0.html" role="button" title="Book 1">
          <i class="fa-solid fa-book"></i>
        </a>

        <!-- Book 2: sách kèm bookmark -->
        <a data-mdb-ripple-init class="btn text-white btn-floating m-1" style="background-color:#6f42c1;"
          href="https://heyzine.com/flip-book/9bdb21a675.html" role="button" title="Book 2">
          <i class="fa-solid fa-book-open"></i>
        </a>

        <!-- Book 3: sách đọc/reader -->
        <a data-mdb-ripple-init class="btn text-white btn-floating m-1" style="background-color:#6f42c1;"
          href="https://heyzine.com/flip-book/e559309fb4.html" role="button" title="Book 3">
          <i class="fa-solid fa-book-open-reader"></i>
        </a>

      </section>


    </div>
    <!-- Grid container -->

    <!-- Copyright -->
    <div class="text-center p-3" style="background-color: rgba(0, 0, 0, 0.173); color:aliceblue">
      <a class="text-center" style="color:aqua" href="index.html">Ryan.com</a>
    </div>
    <!-- Copyright -->
  </footer>
  <script type="module">
    import * as Arcade from './arcade/arcade.js';
    import { Game } from './arcade/game_dreamdrift.js';
    import { pickRewards } from './arcade/rewards.js';

    /* ========= Ritual utils ========= */
    const dayKey = (d = new Date()) => d.toISOString().slice(0, 10);
    const claimKey = () => 'hl_ritual_claimed_' + dayKey();
    function hasRitualDoneToday() {
      try {
        if (!window.HL || typeof HL.getState !== 'function') return false;
        const s = HL.getState(); if (!s) return false;
        const rec = (s.logs || []).find(x => x.date === dayKey());
        const hasBoth = !!(rec && rec.bed && rec.wake);
        const set = s.settings || {};
        const hasPlan = !!(set.target_sleep || set.target_wake);
        return hasBoth && hasPlan;
      } catch (_) { return false; }
    }

    /* ========= Elements ========= */
    const el = {
      streak: document.getElementById('streak'),
      tokens: document.getElementById('tokens'),
      tokenCap: document.getElementById('tokenCap'),
      btnRitual: document.getElementById('btnRitual'),
      btnPlay: document.getElementById('btnPlay'),
      btnExport: document.getElementById('btnExport'),
      gateMsg: document.getElementById('gateMsg'),
      curfew: document.getElementById('curfew'),
      limit: document.getElementById('limit'),
      resultCard: document.getElementById('resultCard'),
      resultBody: document.getElementById('resultBody'),
      btnReplay: document.getElementById('btnReplay'),
      btnClose: document.getElementById('btnClose'),
      canvas: document.getElementById('gg'),
      gameWrap: document.getElementById('gameWrap'),
      zoneHold: document.getElementById('zoneHold'), // có/không đều OK
      btnFS: document.getElementById('btnFS'),       // có/không đều OK
      skipFx: document.getElementById('skipFx')
    };

    /* ========= Init ========= */
    const state = await Arcade.init('./arcade/config.json');
    state.cfg.arcade.unlock_streak = 9; // mở ở 9 streak

    /* ========= DPR-aware canvas ========= */
    function resizeCanvas() {
      const stage = el.gameWrap?.querySelector('.game-stage') || el.canvas.parentElement || document.body;
      const rect = stage.getBoundingClientRect();
      const dpr = Math.max(1, Math.min(window.devicePixelRatio || 1, 2));
      el.canvas.width = Math.floor(rect.width * dpr);
      el.canvas.height = Math.floor(rect.height * dpr);
      const ctx = el.canvas.getContext('2d');
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // vẽ theo đơn vị CSS pixel
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    /* ========= UI refresh ========= */
    function refreshUI() {
      el.streak.textContent = state.streak.toString();
      el.tokens.textContent = state.tokens.toString();
      el.tokenCap.textContent = state.cfg.arcade.token_cap.toString();
      if (el.curfew) el.curfew.textContent = state.cfg.arcade.curfew;
      if (el.limit) el.limit.textContent = state.cfg.arcade.daily_limit_minutes.toString();

      const gate = Arcade.checkGate(state);
      // nếu dùng arcade.js cũ, tham số 2 bị bỏ qua cũng không sao
      el.gateMsg.textContent = gate ? Arcade.gateMessage(gate, state)
        : `Sẵn sàng chơi! (Token: ${state.tokens}/${state.cfg.arcade.token_cap})`;
      el.btnPlay.disabled = !!gate;

      // +1 Token chỉ bật khi đủ ritual + chưa claim + chưa chạm trần
      const entitled = hasRitualDoneToday();
      const claimed = localStorage.getItem(claimKey()) === '1';
      const capReached = state.tokens >= state.cfg.arcade.token_cap;
      el.btnRitual.disabled = !(entitled && !claimed && !capReached);
      el.btnRitual.title = el.btnRitual.disabled
        ? 'Hoàn thành Ritual (Wake + Bed + Planner) để nhận token — hoặc đã claim hôm nay.'
        : 'Nhấn để nhận +1 Token';
    }
    refreshUI();

    /* ========= Claim token ========= */
    el.btnRitual?.addEventListener('click', () => {
      const entitled = hasRitualDoneToday();
      const claimed = localStorage.getItem(claimKey()) === '1';
      if (!entitled || claimed) return;
      Arcade.completeRitual(state);
      localStorage.setItem(claimKey(), '1');
      refreshUI();
    });

    /* ========= Game flow ========= */
    let game;
    function onGameEnd(stats) {
      Arcade.onGameEnd(state, stats);
      const drops = pickRewards(state.cfg.rewards.drops);
      const xp = state.cfg.rewards.calm_xp_per_run;
      el.resultBody.innerHTML = [
        `<p>Điểm: <b>${stats.score}</b> — Combo max: <b>${stats.comboMax}</b> — Thời lượng: <b>${Math.round(stats.duration_ms / 1000)}s</b></p>`,
        `<p>Calm XP +<b>${xp}</b> • Vật phẩm rơi: <b>${drops.map(d => d.id).join(', ') || '—'}</b></p>`,
        `<p>Liên Hệ <a href="https://www.facebook.com/799741289893787" target="_blank" rel="noopener noreferrer">HL_Ryan</a> để nhận quà</p>`
      ].join('');
      el.resultCard.hidden = false;
      refreshUI();
    }

    function startGame() {
      const gate = Arcade.checkGate(state);
      if (gate) { Arcade.logEvent('arcade_locked', { reason: gate }); refreshUI(); return; }

      // --- bonus theo streak ---
      const cfg = state.cfg.dream_drift;
      const baseHearts = Number(cfg.base_hearts || 2);
      const maxHearts = Number(cfg.max_hearts || 3);
      const extraHeart = (state.streak >= (cfg.bonus_heart_streak || 7)) ? 1 : 0;
      const startingHearts = Math.min(maxHearts, baseHearts + extraHeart);

      const streakBonus = (state.streak >= 3)
        ? (1 + Number(cfg.streak_bonus_at3_pct || 5) / 100)  // ví dụ 1.05
        : 1;

      if (extraHeart) {
        // Ryan nói câu chúc may mắn
        el.gateMsg.textContent = "Hôm nay em giữ nhịp ngon lắm nên Ryan cho thêm 1 tim may mắn.";
        setTimeout(() => { if (el.gateMsg.textContent.includes("Ryan")) el.gateMsg.textContent = ""; }, 3000);
      }

      Arcade.consumeToken(state);
      refreshUI();
      resizeCanvas();

      game = new Game(el.canvas, cfg, {
        skipFx: el.skipFx?.checked,
        startingHearts,
        streakBonus,
        onEnd: onGameEnd
      });

      Arcade.logEvent('game_start', { game_id: 'dream_drift', startingHearts, streakBonus });
      game.start();
    }


    el.btnPlay?.addEventListener('click', startGame);
    el.btnReplay?.addEventListener('click', () => { el.resultCard.hidden = true; startGame(); });
    el.btnClose?.addEventListener('click', () => { el.resultCard.hidden = true; refreshUI(); });
    el.btnExport?.addEventListener('click', () => Arcade.exportLogs());

    /* ========= FOLLOW INPUT (chuột/ngón tay) ========= */
    const moveOpts = { passive: false };
    const feedMove = (e) => { e?.preventDefault?.(); if (game?.setTargetFromEvent) game.setTargetFromEvent(e); };
    const feedTap = (e) => { e?.preventDefault?.(); if (game?.setTargetFromEvent) game.setTargetFromEvent(e); };

    // Canvas
    el.canvas.addEventListener('pointermove', feedMove, moveOpts);
    el.canvas.addEventListener('mousemove', feedMove);
    el.canvas.addEventListener('touchmove', feedMove, moveOpts);
    ['pointerdown', 'mousedown', 'touchstart'].forEach(ev => el.canvas.addEventListener(ev, feedTap, moveOpts));

    // Overlay (nếu có)
    if (el.zoneHold) {
      el.zoneHold.addEventListener('pointermove', feedMove, moveOpts);
      el.zoneHold.addEventListener('touchmove', feedMove, moveOpts);
      el.zoneHold.addEventListener('mousemove', feedMove);
      ['pointerdown', 'mousedown', 'touchstart'].forEach(ev => el.zoneHold.addEventListener(ev, feedTap, moveOpts));
    }

    /* ========= Fullscreen (nếu có nút) ========= */
    el.btnFS?.addEventListener('click', async () => {
      const stage = el.gameWrap?.querySelector('.game-stage') || el.gameWrap || document.body;
      try {
        if (!document.fullscreenElement) {
          await stage.requestFullscreen?.();
          if (screen.orientation?.lock) { try { await screen.orientation.lock('portrait'); } catch (_) { } }
          el.btnFS.innerHTML = '<i class="fa-solid fa-compress"></i>';
          el.btnFS.title = 'Thoát toàn màn hình';
        } else {
          await document.exitFullscreen?.();
          el.btnFS.innerHTML = '<i class="fa-solid fa-expand"></i>';
          el.btnFS.title = 'Mở toàn màn hình';
        }
        setTimeout(resizeCanvas, 50);
      } catch (_) { resizeCanvas(); }
    });

    // cập nhật UI (cooldown/daily limit/entitlement) mỗi giây
    setInterval(refreshUI, 1000);
  </script>




  <i class="fa-solid fa-circle-arrow-up" onclick="botToTop()" id="botToTopBtn"></i>
  <script src="js/product.js"></script>
  <script src="bot_to_top.js"></script>
  <script src="hl/state.js"></script>
  <script src="hl/sortButton.js"></script>
  <script src="hl/logger.js"></script>
  <script src="hl/settings.js"></script>
  <script src="hl/sjl.metrics.js"></script>
  <script src="hl/sjl.heatmap.js"></script>
  <script src="hl/dashboard.js"></script>
  <script src="hl/planner.js"></script>
  <script src="hl/examday.js"></script>
  <script src="hl/jitai.js"></script>
  <script src="hl/datalab.js"></script>
  <script src="hl/onboarding.js"></script>
  <script src="hl/sheets.sync.js"></script>


</body>

</html>