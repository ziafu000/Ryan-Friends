<!doctype html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Harmony Arcade</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="index.css">
  <link rel="icon" href="img/Logo.png">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#22d3ee">

</head>

<body>
  <nav class="navbar navbar-expand-sm navbar-dark bg-dark">
    <a class="navbar-brand" href="index.html">
      <img src="img/Logo.png" alt="Logo" style="width:60px;">
    </a>

    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#mainNav" aria-controls="mainNav"
      aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="mainNav">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item">
          <a class="nav-link" href="index.html"><i class="fas fa-home"></i> Trang ch·ªß</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="introduce.html"><i class="fas fa-tasks"></i> Nhi·ªám v·ª• h·∫±ng ng√†y</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="PSQI.html"><i class="fas fa-chart-bar"></i> T√≠nh PSQI</a>
        </li>
        <li class="nav-item active">
          <a class="nav-link" href="arcade.html"><i class="fas fa-gamepad"></i> Harmony Arcade</a>
        </li>
        <!-- NEW: Habit Garden -->
        <li class="nav-item">
          <a class="nav-link" href="garden.html"><i class="fas fa-leaf"></i> Khu v∆∞·ªùn th√≥i quen</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="SJL.html"><i class="fas fa-moon"></i> SJL</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="QnA.html"><i class="fas fa-comments"></i> Talkshow Q&A </a>
        </li>
      </ul>
    </div>
  </nav>


  <main class="container mt-3 mb-3">
    <section class="card p-3" aria-live="polite">
      <h1 class="card-title mb-2">Harmony Arcade ‚Äî <span class="badge-primary">Dream Drift</span></h1>

      <div class="mt-2 d-flex flex-wrap align-items-center" style="gap:8px;">
        <span class="badge-primary">Streak: <span id="streak">0</span></span>
        <span class="badge-primary">Play Tokens: <span id="tokens">0</span>/<span id="tokenCap">3</span></span>
        <span class="badge-primary">Gi·ªõi h·∫°n: <span id="limit">10</span> ph√∫t/ng√†y</span>
        <span class="badge-primary">Gi·ªù ng·ªß: <span id="curfew">21:30</span></span>
      </div>

      <p class="text-muted mt-2">Ho√†n th√†nh <b>Daily Ritual</b> ƒë·ªÉ nh·∫≠n token. ƒê·ªß <b>9 streak</b> s·∫Ω m·ªü <i>Harmony
          Arcade</i>. Ch∆°i ‚â§ <b>90s/v√°n</b>, cooldown <b>3 ph√∫t</b>, t·ªëi ƒëa <b>10 ph√∫t/ng√†y</b>.</p>

      <div class="d-flex flex-wrap align-items-center" style="gap:8px;">
        <button id="btnRitual" class="btn btn-outline-secondary">+1 Token (Ho√†n th√†nh Ritual)</button>
        <button id="btnPlay" class="btn btn-primary">Ch∆°i</button>
        <button id="btnExport" class="btn btn-outline-secondary">Xu·∫•t log</button>

        <div class="form-check ml-2">
          <input type="checkbox" class="form-check-input" id="skipFx">
          <label class="form-check-label" for="skipFx">B·ªè qua hi·ªáu ·ª©ng</label>
        </div>
      </div>

      <p class="text-muted text-center mt-3">
        <small>
          <b>Di chuy·ªÉn:</b> r√™ <kbd>chu·ªôt/ng√≥n tay</kbd> trong khung game.
          <br>
          <b>Skill Dash:</b> gi·ªØ <kbd>Space/ng√≥n tay</kbd> ƒë·ªÉ n·∫°p, nh·∫£ <kbd>Space</kbd> ƒë·ªÉ l∆∞·ªõt.
        </small>
      </p>


      <!-- Khung game c√≥ overlay + n√∫t fullscreen -->
      <div id="gameWrap" class="game-wrap d-flex justify-content-center mx-auto p-1">
        <div class="game-stage">
          <canvas id="gg" aria-label="Khung tr√≤ ch∆°i Dream Drift"></canvas>

          <!-- V√πng overlay: GI·ªÆ ƒë·ªÉ bay l√™n, NH·∫¢ ƒë·ªÉ h·∫° xu·ªëng -->
          <div id="zoneHold" class="zone-hold p-3" aria-label="Gi·ªØ ƒë·ªÉ bay l√™n"></div>
        </div>
      </div>
      <!-- N√öT FULLSCREEN ƒê√É D·ªúI RA NGO√ÄI -->
      <div class="d-flex justify-content-center mb-2">
        <button id="btnFS" type="button" class="btn btn-dark btn-sm" title="M·ªü to√†n m√†n h√¨nh">
          <i class="fa-solid fa-expand"></i> To√†n m√†n h√¨nh
        </button>
      </div>

      <!-- (tu·ª≥ ch·ªçn) Pad 2 n√∫t truy·ªÅn th·ªëng v·∫´n gi·ªØ ƒë∆∞·ª£c
      <div class="d-flex justify-content-center mt-2" id="pad">
        <div class="btn-group" role="group" aria-label="ƒêi·ªÅu khi·ªÉn Dream Drift">
          <button id="btnHoldUp" class="btn btn-info btn-lg px-4" type="button">
            <i class="fa-solid fa-arrow-up"></i> Bay l√™n
          </button>
          <button id="btnHoldOff" class="btn btn-secondary btn-lg px-4" type="button">
            <i class="fa-solid fa-arrow-down"></i> H·∫° xu·ªëng
          </button>
        </div>
      </div> -->


      <div id="dd-end-panel" class="dd-end-panel" style="display:none; margin-top:12px;"></div>
      <p id="gateMsg" class="text-accent text-center mt-2 mb-0"></p>
    </section>

    <section id="resultCard" class="card hl-modal-card mt-3" hidden>
      <div class="modal-header d-flex justify-content-between align-items-center">
        <h2 class="modal-title mb-0" id="resultTitle">K·∫øt qu·∫£</h2>
      </div>
      <div id="resultBody" class="modal-content"
        style="border:none; box-shadow:none; background:transparent; padding:12px 16px;"></div>
      <div class="modal-footer d-flex" style="gap:8px;">
        <button id="btnReplay" class="btn btn-primary">Ch∆°i l·∫°i</button>
        <button id="btnClose" class="btn btn-outline-secondary">ƒê√≥ng</button>
      </div>
    </section>
  </main>

  <footer class="mt-3 bg-dark text-light">
    <div class="container py-4 pb-0">
      <div class="row align-items-center">
        <!-- Text b√™n tr√°i (tr√™n mobile n·∫±m tr√™n, PC n·∫±m b√™n tr√°i) -->
        <div class="col-12 col-md-4 text-center text-md-left mb-3 mb-md-0">
          <h6 class="mb-1">K·∫øt n·ªëi v·ªõi Little Ryan</h6>
          <small class="text-muted">M·∫°ng x√£ h·ªôi & t√†i li·ªáu tham kh·∫£o</small>
        </div>

        <!-- Icon m·∫°ng x√£ h·ªôi: mobile th√¨ n·∫±m gi·ªØa, PC th√¨ d·ªìn v·ªÅ b√™n ph·∫£i -->
        <div class="col-12 col-md-8">
          <div class="d-flex flex-wrap justify-content-center justify-content-md-end">
            <!-- Facebook -->
            <a class="btn text-white btn-floating m-1" style="background-color: #3b5998;"
              href="https://www.facebook.com/people/Little-Ryan/61581956524218" role="button" title="Facebook">
              <i class="fab fa-facebook-f"></i>
            </a>

            <!-- Instagram -->
            <a class="btn text-white btn-floating m-1" style="background-color: #ac2bac;"
              href="https://www.instagram.com/lil_ryan091701?igsh=c2E2ZHprZHBjZGl4" role="button" title="Instagram">
              <i class="fab fa-instagram"></i>
            </a>

            <!-- YouTube -->
            <a class="btn text-white btn-floating m-1" style="background-color: #ed302f;"
              href="https://www.youtube.com/@lilryan4B" role="button" title="YouTube">
              <i class="fab fa-youtube"></i>
            </a>

            <!-- Chat GPT -->
            <a class="btn text-white btn-floating m-1" style="background-color: #00acee;"
              href="https://chatgpt.com/g/g-68de0cbfdde88191aef354c4a1e4a6e1-mental-coach-from-btx-hs-by-minh-phu"
              role="button" title="Chatbot">
              <i class="fa-solid fa-robot"></i>
            </a>

            <!-- Book 1 -->
            <a class="btn text-white btn-floating m-1" style="background-color:#7952b3;"
              href="https://heyzine.com/flip-book/0f2d1691bb.html" role="button" title="Book 1">
              <i class="fa-solid fa-book"></i>
            </a>

            <!-- Book 2 -->
            <a class="btn text-white btn-floating m-1" style="background-color:#6f42c1;"
              href="https://heyzine.com/flip-book/3593172525.html" role="button" title="Book 2">
              <i class="fa-solid fa-book-open"></i>
            </a>

            <!-- Book 3 -->
            <a class="btn text-white btn-floating m-1" style="background-color:#6f42c1;"
              href="https://heyzine.com/flip-book/539826d9aa.html" role="button" title="Book 3">
              <i class="fa-solid fa-book-open-reader"></i>
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Copyright -->
    <div class="text-center p-3" style="background-color: rgba(0, 0, 0, 0.173);">
      <a href="index.html" class="text-info">Ryan.com</a>
    </div>
  </footer>

  <script type="module">
    import * as Arcade from './arcade/arcade.js';
    import { Game } from './arcade/game_dreamdrift.js';
    import { pickRewards } from './arcade/rewards.js';

    /* ========= Ritual utils ========= */
    const dayKey = (d = new Date()) => d.toISOString().slice(0, 10);
    const claimKey = () => 'hl_ritual_claimed_' + dayKey();
    function hasRitualDoneToday() {
      try {
        if (!window.HL || typeof HL.getState !== 'function') return false;
        const s = HL.getState(); if (!s) return false;
        const rec = (s.logs || []).find(x => x.date === dayKey());
        const hasBoth = !!(rec && rec.bed && rec.wake);
        const set = s.settings || {};
        const hasPlan = !!(set.target_sleep || set.target_wake);
        return hasBoth && hasPlan;
      } catch (_) { return false; }
    }

    /* ========= Elements ========= */
    const el = {
      streak: document.getElementById('streak'),
      tokens: document.getElementById('tokens'),
      tokenCap: document.getElementById('tokenCap'),
      btnRitual: document.getElementById('btnRitual'),
      btnPlay: document.getElementById('btnPlay'),
      btnExport: document.getElementById('btnExport'),
      gateMsg: document.getElementById('gateMsg'),
      curfew: document.getElementById('curfew'),
      limit: document.getElementById('limit'),
      resultCard: document.getElementById('resultCard'),
      resultBody: document.getElementById('resultBody'),
      btnReplay: document.getElementById('btnReplay'),
      btnClose: document.getElementById('btnClose'),
      canvas: document.getElementById('gg'),
      gameWrap: document.getElementById('gameWrap'),
      zoneHold: document.getElementById('zoneHold'), // c√≥/kh√¥ng ƒë·ªÅu OK
      btnFS: document.getElementById('btnFS'),       // c√≥/kh√¥ng ƒë·ªÅu OK
      skipFx: document.getElementById('skipFx')
    };

    /* ========= Init ========= */
    const state = await Arcade.init('./arcade/config.json');
    state.cfg.arcade.unlock_streak = 9; // m·ªü ·ªü 9 streak

    /* ========= DPR-aware canvas ========= */
    function resizeCanvas() {
      const stage = el.gameWrap?.querySelector('.game-stage') || el.canvas.parentElement || document.body;
      const rect = stage.getBoundingClientRect();
      const dpr = Math.max(1, Math.min(window.devicePixelRatio || 1, 2));
      el.canvas.width = Math.floor(rect.width * dpr);
      el.canvas.height = Math.floor(rect.height * dpr);
      const ctx = el.canvas.getContext('2d');
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // v·∫Ω theo ƒë∆°n v·ªã CSS pixel
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    /* ========= UI refresh ========= */
    function refreshUI() {
      el.streak.textContent = state.streak.toString();
      el.tokens.textContent = state.tokens.toString();
      el.tokenCap.textContent = state.cfg.arcade.token_cap.toString();
      if (el.curfew) el.curfew.textContent = state.cfg.arcade.curfew;
      if (el.limit) el.limit.textContent = state.cfg.arcade.daily_limit_minutes.toString();

      const gate = Arcade.checkGate(state);
      // n·∫øu d√πng arcade.js c≈©, tham s·ªë 2 b·ªã b·ªè qua c≈©ng kh√¥ng sao
      el.gateMsg.textContent = gate ? Arcade.gateMessage(gate, state)
        : `S·∫µn s√†ng ch∆°i! (Token: ${state.tokens}/${state.cfg.arcade.token_cap})`;
      el.btnPlay.disabled = !!gate;

      // +1 Token ch·ªâ b·∫≠t khi ƒë·ªß ritual + ch∆∞a claim + ch∆∞a ch·∫°m tr·∫ßn
      const entitled = hasRitualDoneToday();
      const claimed = localStorage.getItem(claimKey()) === '1';
      const capReached = state.tokens >= state.cfg.arcade.token_cap;
      el.btnRitual.disabled = !(entitled && !claimed && !capReached);
      el.btnRitual.title = el.btnRitual.disabled
        ? 'Ho√†n th√†nh Ritual (Wake + Bed + Planner) ƒë·ªÉ nh·∫≠n token ‚Äî ho·∫∑c ƒë√£ claim h√¥m nay.'
        : 'Nh·∫•n ƒë·ªÉ nh·∫≠n +1 Token';
    }
    refreshUI();

    /* ========= Claim token ========= */
    el.btnRitual?.addEventListener('click', () => {
      const entitled = hasRitualDoneToday();
      const claimed = localStorage.getItem(claimKey()) === '1';
      if (!entitled || claimed) return;
      Arcade.completeRitual(state);
      localStorage.setItem(claimKey(), '1');
      refreshUI();
    });

    /* ========= Game flow ========= */
    let game;
    // ===== ƒêi·ªÅu khi·ªÉn skill b·∫±ng ph√≠m SPACE =====
    let isSpaceDown = false;

    window.addEventListener(
      'keydown',
      (e) => {
        // M·ªôt s·ªë browser d√πng e.code = "Space", m·ªôt s·ªë d√πng e.key = " "
        if (e.code === 'Space' || e.key === ' ') {
          if (isSpaceDown) return;        // tr√°nh spam khi keydown l·∫∑p
          isSpaceDown = true;
          if (game) game.startCharge();   // b·∫Øt ƒë·∫ßu n·∫°p chi√™u
          e.preventDefault();
        }
      },
      { passive: false }
    );

    window.addEventListener(
      'keyup',
      (e) => {
        if (e.code === 'Space' || e.key === ' ') {
          isSpaceDown = false;
          if (game) game.releaseDash();   // nh·∫£ chi√™u ‚Üí dash
          e.preventDefault();
        }
      },
      { passive: false }
    );

    function onGameEnd(stats) {
      // g·ªçi rewards / arcade logic c√≥ s·∫µn
      Arcade.onGameEnd(state, stats);   // n·∫øu b·∫°n ƒëang c√≥ h√†m n√†y, gi·ªØ l·∫°i

      const s = stats;
      const sec = Math.round(s.duration_ms / 1000);
      const dps = s.duration_ms > 0 ? (s.bossDamage / (s.duration_ms / 1000)) : 0;

      const html = `
    <div class="card" style="padding:12px;">
      <h3 style="margin-bottom:8px;">‚ú® Th√†nh t·ª±u h√¥m nay ‚ú®</h3>
      <p>üåü ƒêi·ªÉm cu·ªëi: <b>${s.score}</b></p>
      <p>üî• Damage l√™n Boss: <b>${s.bossDamage}</b> (DPS: <b>${dps.toFixed(1)}</b>)</p>
      <p>üéØ L·∫ßn ch·∫°m Boss: <b>${s.bossHits}</b></p>
      <p>üí• S·ªë l·∫ßn Dash: <b>${s.dashCount}</b></p>
      <p>üöÄ Level ti·∫øn ho√° ƒë·∫°t ƒë∆∞·ª£c: <b>${s.evoLevel}</b></p>
      <p>üéÆ Combo cao nh·∫•t: <b>${s.comboMax}</b></p>
      <p>‚è± Th·ªùi gian s·ªëng s√≥t: <b>${sec}s</b></p>
      <p>üåÄ H·ªá s·ªë cu·ªëi c√πng: <b>${s.multNow.toFixed(2)}x</b></p>
    </div>
  `;

      const panel = document.getElementById('dd-end-panel');
      if (panel) {
        panel.innerHTML = html;
        panel.style.display = 'block';
      }

      // refresh UI token/streak nh∆∞ tr∆∞·ªõc
      refreshUI();
    }


    function startGame() {
      const gate = Arcade.checkGate(state);
      if (gate) { Arcade.logEvent('arcade_locked', { reason: gate }); refreshUI(); return; }

      // --- bonus theo streak ---
      const cfg = state.cfg.dream_drift;
      const baseHearts = Number(cfg.base_hearts || 2);
      const maxHearts = Number(cfg.max_hearts || 3);
      const extraHeart = (state.streak >= (cfg.bonus_heart_streak || 7)) ? 1 : 0;
      const startingHearts = Math.min(maxHearts, baseHearts + extraHeart);

      const streakBonus = (state.streak >= 3)
        ? (1 + Number(cfg.streak_bonus_at3_pct || 5) / 100)  // v√≠ d·ª• 1.05
        : 1;

      if (extraHeart) {
        // Ryan n√≥i c√¢u ch√∫c may m·∫Øn
        el.gateMsg.textContent = "H√¥m nay em gi·ªØ nh·ªãp ngon l·∫Øm n√™n Ryan cho th√™m 1 tim may m·∫Øn.";
        setTimeout(() => { if (el.gateMsg.textContent.includes("Ryan")) el.gateMsg.textContent = ""; }, 3000);
      }

      Arcade.consumeToken(state);
      refreshUI();
      resizeCanvas();

      game = new Game(el.canvas, cfg, {
        skipFx: el.skipFx?.checked,
        startingHearts,
        streakBonus,
        onEnd: onGameEnd
      });

      Arcade.logEvent('game_start', { game_id: 'dream_drift', startingHearts, streakBonus });
      game.start();
    }


    el.btnPlay?.addEventListener('click', startGame);
    el.btnReplay?.addEventListener('click', () => { el.resultCard.hidden = true; startGame(); });
    el.btnClose?.addEventListener('click', () => { el.resultCard.hidden = true; refreshUI(); });
    el.btnExport?.addEventListener('click', () => Arcade.exportLogs());

    /* ========= FOLLOW INPUT (chu·ªôt/ng√≥n tay) ========= */
    const moveOpts = { passive: false };
    const feedMove = (e) => { e?.preventDefault?.(); if (game?.setTargetFromEvent) game.setTargetFromEvent(e); };
    const feedTap = (e) => { e?.preventDefault?.(); if (game?.setTargetFromEvent) game.setTargetFromEvent(e); };

    // Canvas
    el.canvas.addEventListener('pointermove', feedMove, moveOpts);
    el.canvas.addEventListener('mousemove', feedMove);
    el.canvas.addEventListener('touchmove', feedMove, moveOpts);
    // Gi·ªØ chu·ªôt/ch·∫°m ƒë·ªÉ charge, th·∫£ ƒë·ªÉ dash
    el.canvas.addEventListener('mousedown', (e) => {
      if (game) game.startCharge();
    });
    el.canvas.addEventListener('mouseup', (e) => {
      if (game) game.releaseDash();
    });

    el.canvas.addEventListener('touchstart', (e) => {
      if (game) game.startCharge();
    });
    el.canvas.addEventListener('touchend', (e) => {
      if (game) game.releaseDash();
    });

    ['pointerdown', 'mousedown', 'touchstart'].forEach(ev => el.canvas.addEventListener(ev, feedTap, moveOpts));

    // Overlay (n·∫øu c√≥)
    if (el.zoneHold) {
      el.zoneHold.addEventListener('pointermove', feedMove, moveOpts);
      el.zoneHold.addEventListener('touchmove', feedMove, moveOpts);
      el.zoneHold.addEventListener('mousemove', feedMove);
      ['pointerdown', 'mousedown', 'touchstart'].forEach(ev => el.zoneHold.addEventListener(ev, feedTap, moveOpts));
    }

    /* ========= Fullscreen (n·∫øu c√≥ n√∫t) ========= */
    el.btnFS?.addEventListener('click', async () => {
      const stage = el.gameWrap?.querySelector('.game-stage') || el.gameWrap || document.body;
      try {
        if (!document.fullscreenElement) {
          await stage.requestFullscreen?.();
          if (screen.orientation?.lock) { try { await screen.orientation.lock('portrait'); } catch (_) { } }
          el.btnFS.innerHTML = '<i class="fa-solid fa-compress"></i>';
          el.btnFS.title = 'Tho√°t to√†n m√†n h√¨nh';
        } else {
          await document.exitFullscreen?.();
          el.btnFS.innerHTML = '<i class="fa-solid fa-expand"></i>';
          el.btnFS.title = 'M·ªü to√†n m√†n h√¨nh';
        }
        setTimeout(resizeCanvas, 50);
      } catch (_) { resizeCanvas(); }
    });

    // c·∫≠p nh·∫≠t UI (cooldown/daily limit/entitlement) m·ªói gi√¢y
    setInterval(refreshUI, 1000);
  </script>




  <script src="hl/toggleMenu.js"></script>
  <script src="hl/state.js"></script>
  <script src="hl/sortButton.js"></script>
  <script src="hl/logger.js"></script>
  <script src="hl/settings.js"></script>
  <script src="hl/sjl.metrics.js"></script>
  <script src="hl/sjl.heatmap.js"></script>
  <script src="hl/dashboard.js"></script>
  <script src="hl/planner.js"></script>
  <script src="hl/examday.js"></script>
  <script src="hl/jitai.js"></script>
  <script src="hl/datalab.js"></script>
  <script src="hl/onboarding.js"></script>
  <script src="hl/sheets.sync.js"></script>


</body>

</html>